-- 26. Create a customer summary (total orders, total spend, avg order value, last order date).

SELECT 
	t1.order_id, COUNT(*) 
AS 
	total_order, SUM(payment_value) 
AS 
	total_spend, ROUND(AVG(payment_value), 2) 
AS 
	avg_order_value, 
	LAST_VALUE(order_purchase_timestamp) 
	OVER(PARTITION BY order_id) 
AS 
	last_order_date 
FROM 
	project.olist_order_items_dataset t1 
JOIN 	
	project.olist_order_payments_dataset t2 
ON 
	t1.order_id = t2.order_id 
JOIN 
	olist_orders_dataset t3 
ON 	
	t2.order_id = t3.order_id 
GROUP BY 	
	order_id, order_purchase_timestamp 
ORDER BY 
	COUNT(*) DESC;
